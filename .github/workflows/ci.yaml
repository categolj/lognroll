name: CI
on:
  push:
    branches:
    - main
    paths:
    - src/**
    - ui/**
    - pom.xml
    - .github/workflows/*
  pull_request:
    branches:
    - main
    paths:
    - src/**
    - ui/**
    - pom.xml
    - .github/workflows/*
  workflow_dispatch:
jobs:
  test:
    uses: making/workflows/.github/workflows/maven-unit-test.yaml@main
    with:
      e2e_test: true
      test_url_1: http://localhost:8080/actuator/health
      upload_target: false
  build-jvm-image:
    needs: test
    permissions:
      contents: read
      packages: write
    uses: making/workflows/.github/workflows/build-docker-image-maven-jvm.yaml@main
    with:
      image_file: image.yaml
      download_target: false
  build-native-image:
    needs: test
    permissions:
      contents: read
      packages: write
    uses: making/workflows/.github/workflows/build-docker-image-maven-native.yaml@main
    with:
      image_file: image_native.yaml
      download_target: false
      e2e_test: true
      test_url_1: http://localhost:8080/actuator/health
      # TODO how to test?
      #  cat src/test/resources/logs.json | curl -H "Content-Type: application/json" -H "Authorization: Bearer changeme" --fail --show-error --silent http://localhost:8080/v1/logs --data-binary @- -v
      #  curl -s http://localhost:8080/api/logs -H "Authorization: Bearer changeme" | jq .
  build-native-x86_64-pc-linux:
    needs: test
    permissions:
      contents: write
    uses: making/workflows/.github/workflows/build-native-image.yaml@main
    with:
      download_target: false
      e2e_test: true
      test_url_1: http://localhost:8080/actuator/health
      runs-on: ubuntu-latest
      binary_suffix: -x86_64-pc-linux
  build-native-aarch64-apple-darwin:
    needs: test
    permissions:
      contents: write
    uses: making/workflows/.github/workflows/build-native-image.yaml@main
    with:
      download_target: false
      e2e_test: true
      test_url_1: http://localhost:8080/actuator/health
      runs-on: macos-14
      binary_suffix: -aarch64-apple-darwin
  deploy-to-fly:
    needs: build-native-image
    permissions:
      id-token: write
      contents: read
    uses: ./.github/workflows/deploy-to-fly.yaml
    secrets:
      vault_url: ${{ secrets.VAULT_ADDR }}